version: '3.8'

# DevGuard CI/CD Runners
# 包含 Build Runner 和 Test Runner

services:
  # Gitea Actions Runner - Build
  gitea-runner-build:
    image: gitea/act_runner:latest
    container_name: devguard-runner-build
    environment:
      - GITEA_INSTANCE_URL=${GITEA_ROOT_URL:-http://localhost:3000}
      - GITEA_RUNNER_REGISTRATION_TOKEN=${GITEA_RUNNER_TOKEN}
      - GITEA_RUNNER_NAME=build-runner-01
      - GITEA_RUNNER_LABELS=ubuntu-latest:docker://node:18-bullseye,ubuntu-22.04:docker://ubuntu:22.04,build:docker://node:18-bullseye
      - CONFIG_FILE=/data/config.yaml
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /data/runners/build:/data
      - /tmp:/tmp
    restart: unless-stopped
    networks:
      - devguard-network
    depends_on:
      - gitea
    labels:
      - "devguard.service=runner-build"
      - "devguard.description=Build and compilation runner"
    profiles:
      - runners

  # Gitea Actions Runner - Test
  gitea-runner-test:
    image: gitea/act_runner:latest
    container_name: devguard-runner-test
    environment:
      - GITEA_INSTANCE_URL=${GITEA_ROOT_URL:-http://localhost:3000}
      - GITEA_RUNNER_REGISTRATION_TOKEN=${GITEA_RUNNER_TOKEN}
      - GITEA_RUNNER_NAME=test-runner-01
      - GITEA_RUNNER_LABELS=test:docker://node:18-bullseye,python:docker://python:3.10,java:docker://openjdk:17
      - CONFIG_FILE=/data/config.yaml
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /data/runners/test:/data
      - /tmp:/tmp
    restart: unless-stopped
    networks:
      - devguard-network
    depends_on:
      - gitea
    labels:
      - "devguard.service=runner-test"
      - "devguard.description=Testing and quality assurance runner"
    profiles:
      - runners

  # Docker-in-Docker 服务（用于容器构建）
  docker-dind:
    image: docker:dind
    container_name: devguard-docker-dind
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=/certs
    volumes:
      - /data/runners/dind-certs-ca:/certs/ca
      - /data/runners/dind-certs-client:/certs/client
      - /data/runners/dind-data:/var/lib/docker
    restart: unless-stopped
    networks:
      - devguard-network
    labels:
      - "devguard.service=docker-dind"
      - "devguard.description=Docker-in-Docker for container builds"
    profiles:
      - runners
      - dind

  # 多架构构建 Runner
  gitea-runner-multiarch:
    image: gitea/act_runner:latest
    container_name: devguard-runner-multiarch
    environment:
      - GITEA_INSTANCE_URL=${GITEA_ROOT_URL:-http://localhost:3000}
      - GITEA_RUNNER_REGISTRATION_TOKEN=${GITEA_RUNNER_TOKEN}
      - GITEA_RUNNER_NAME=multiarch-runner-01
      - GITEA_RUNNER_LABELS=multiarch:docker://multiarch/qemu-user-static,arm64:docker://arm64v8/ubuntu:22.04,amd64:docker://amd64/ubuntu:22.04
      - CONFIG_FILE=/data/config.yaml
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /data/runners/multiarch:/data
      - /tmp:/tmp
    restart: unless-stopped
    networks:
      - devguard-network
    depends_on:
      - gitea
    labels:
      - "devguard.service=runner-multiarch"
      - "devguard.description=Multi-architecture build runner"
    profiles:
      - runners
      - multiarch

  # 性能测试 Runner
  gitea-runner-performance:
    image: gitea/act_runner:latest
    container_name: devguard-runner-performance
    environment:
      - GITEA_INSTANCE_URL=${GITEA_ROOT_URL:-http://localhost:3000}
      - GITEA_RUNNER_REGISTRATION_TOKEN=${GITEA_RUNNER_TOKEN}
      - GITEA_RUNNER_NAME=performance-runner-01
      - GITEA_RUNNER_LABELS=performance:docker://loadimpact/k6,stress:docker://williamyeh/wrk
      - CONFIG_FILE=/data/config.yaml
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /data/runners/performance:/data
      - /tmp:/tmp
    restart: unless-stopped
    networks:
      - devguard-network
    depends_on:
      - gitea
    labels:
      - "devguard.service=runner-performance"
      - "devguard.description=Performance and load testing runner"
    profiles:
      - runners
      - performance

networks:
  devguard-network:
    external: true

volumes:
  runner-build-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/runners/build
    labels:
      - "devguard.volume=runner-build-data"
  
  runner-test-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/runners/test
    labels:
      - "devguard.volume=runner-test-data"